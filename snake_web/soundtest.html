<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>VICE.js sound test</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #canvas {
        border: 0;
        padding: 0;
        display: block;
      }

      /* Simple full-screen overlay with a start button */
      #start-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 1rem;
        z-index: 10;
      }

      #start-overlay button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border-radius: 4px;
        border: 1px solid #fff;
        background: #222;
        color: #fff;
        cursor: pointer;
      }

      #start-overlay button:hover {
        background: #444;
      }
    </style>
  </head>
  <body>
    <!-- canvas must not have border/padding for VICE.js -->
    <canvas id="canvas"></canvas>

    <div id="start-overlay">
      <div>Click to start the Commodore 64 emulator with sound.</div>
      <button type="button" onclick="startEmulator()">Start</button>
    </div>

    <script type="text/javascript">
      function audioDetected() {
        return (typeof Audio === 'function' && new Audio().mozSetup === 'function') ||
               (typeof AudioContext === 'function') ||
               (typeof webkitAudioContext === 'function');
      }

      // Module must be global so x64.js can see it
      var Module = null;

      function startEmulator() {
        // Avoid double-start if user clicks twice
        if (Module !== null) {
          return;
        }

        // Hide overlay now that we have a user gesture
        document.getElementById('start-overlay').style.display = 'none';

        // Same logic you had before: sound enabled on capable browsers
        var viceArguments = audioDetected()
          ? ['-soundsync', 0, '-soundrate', 22050, '-soundfragsize', 2]
          : ['-sound'];

        console.log('Starting VICE with args:', viceArguments);

        Module = {
          arguments: viceArguments,
          canvas: document.getElementById('canvas')
        };

        // Dynamically load x64.js AFTER the click
        var script = document.createElement('script');
        script.src = 'js/x64.js';
        script.async = true;
        document.body.appendChild(script);
      }
    </script>
  </body>
</html>
